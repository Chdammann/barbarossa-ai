<!DOCTYPE html>
<html lang="de">
<head>
<link rel="icon" href="avatar.png" type="image/png">
<link rel="apple-touch-icon" href="avatar.png">
<meta name="theme-color" content="#000000">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Frag Friedrich Barbarossa</title>
<style>
body {
  margin: 0;
  overflow: hidden;
  background-color: black;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  flex-direction: column;
  font-family: "Georgia", serif;
  color: white;
}
h1 {
  position: absolute;
  top: 20px;
  text-align: center;
  width: 100%;
  font-size: 2em;
  color: #e0b36b;
  text-shadow: 0 0 10px #000;
  letter-spacing: 2px;
  animation: pulse 3s ease-in-out infinite;
}
@keyframes pulse {
  0%,100% { transform: scale(1); opacity:1; }
  50% { transform: scale(1.05); opacity:0.9; }
}
#avatarCanvas { width: 100%; height: 100%; display: block; }
#loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  color: #ccc;
  font-size: 1.2em;
  text-align: center;
}
#micBtn {
  position: absolute;
  bottom: 60px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: #222;
  color: white;
  border: none;
  font-size: 32px;
  cursor: pointer;
  z-index: 10;
}
#micBtn:hover { background:#444; }
#micNotice {
  position: absolute;
  bottom: 140px;
  width: 100%;
  text-align: center;
  color: #aaa;
  font-size: 0.9em;
}
footer {
  position: absolute;
  bottom: 15px;
  width: 100%;
  text-align: center;
  font-size: 0.8em;
  color: #aaa;
}
footer a { color:#aaa; text-decoration:none; }
footer a:hover { text-decoration: underline; }
</style>
</head>
<body>
<h1>Frag Friedrich</h1>
<div id="loading">Avatar wird geladenâ€¦</div>
<canvas id="avatarCanvas"></canvas>
<button id="micBtn">ðŸŽ¤</button>
<div id="micNotice"></div>
<footer>
Â© 2025 <a href="https://christoph-dammann.de" target="_blank">Dr. Christoph Dammann</a>
</footer>

<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
// === STATES ===
let STATE = "idle";  // idle â†’ greet â†’ listen â†’ hmmm â†’ answer â†’ backToIdle
let model, recognizing = false, talking = false;
let lastTranscript = ""; 
let hmStartTime = 0, riseStartTime = 0;
const hmDuration = 2000, riseDuration = 1800;
let baseRotX = 0.25, baseRotY = -0.35;

// === THREE.JS SETUP ===
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(30, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0,0,2.8);
const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("avatarCanvas"), antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setClearColor(0x000000);
scene.add(new THREE.DirectionalLight(0xffffff,2).position.set(1,1,2));
scene.add(new THREE.AmbientLight(0xffffff,0.9));
const light = new THREE.DirectionalLight(0xffffff,2);
light.position.set(1,1,2);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff,0.8));
const frontLight = new THREE.PointLight(0xffffff,0.8);
frontLight.position.set(0,0.5,2);
scene.add(frontLight);

// === LOAD AVATAR ===
new THREE.GLTFLoader().load("./avatar.glb", gltf => {
  model = gltf.scene;
  model.rotation.set(baseRotX, baseRotY - Math.PI/2, 0); // â†’ idle pose (leicht nach rechts)
  scene.add(model);
  document.getElementById("loading").style.display = "none";
  animate();
});

// === ANIMATE / STATE MACHINE ===
function animate(){
  requestAnimationFrame(animate);
  if(!model) return;
  const t = performance.now();

  switch(STATE){
    case "idle": // leicht geneigt nach rechts
      model.rotation.y += (baseRotY - Math.PI/2 - model.rotation.y) * 0.05;
      break;
    case "greet": // ganz frontal
      model.rotation.y += (0 - model.rotation.y) * 0.08;
      break;
    case "listen": // frontal bleiben
      model.rotation.y += (-0.01 - model.rotation.y) * 0.03;
      break;
    case "hmmm": // leicht nach links geneigt
      model.rotation.y += ((baseRotY + 0.25) - model.rotation.y) * 0.03;
      break;
    case "answer": // zurÃ¼ck auf frontal
      model.rotation.y += (0 - model.rotation.y) * 0.05;
      break;
    case "backToIdle": // zurÃ¼ck nach rechts
      model.rotation.y += (baseRotY - Math.PI/2 - model.rotation.y) * 0.04;
      break;
  }

  // leichte Atmung
  model.position.y = Math.sin(t * 0.0015) * 0.01;
  renderer.render(scene, camera);
}

// === SPEECH ===
function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "de-DE"; u.rate = 0.95; u.pitch = 0.7; u.volume = 0.65;
  u.onstart = ()=>{ talking = true; STATE = "answer"; };
  u.onend = ()=>{ talking = false; STATE = "backToIdle"; greeted = false; };
  speechSynthesis.speak(u);
}

const micBtn = document.getElementById("micBtn");
let greeted = false;

micBtn.onclick = () => {
  if(STATE === "idle" && !greeted){
    STATE = "greet";
    greeted = true;
    speak("Seid gegrÃ¼ÃŸt, mein Freund. Sprecht, was begehrt Ihr?");
    return;
  }
  if(STATE === "greet" || STATE === "backToIdle"){
    recognition.start();
    recognizing = true; 
    STATE = "listen"; 
    return;
  }
};

let recognition = new webkitSpeechRecognition();
recognition.lang = "de-DE";
recognition.onend = () => {
  if(STATE === "listen"){
    STATE = "hmmm";
    speak("Hmmm... einen Moment.");
    fetch("/ask", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({text: lastTranscript})
    })
    .then(r => r.json())
    .then(d => speak(d.answer));
  }
};
recognition.onresult = e => lastTranscript = e.results[0][0].transcript;
</script>
</body>
</html>
