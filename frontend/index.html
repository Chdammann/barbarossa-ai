<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Frag Friedrich Barbarossa</title>

<link rel="icon" href="avatar.png" type="image/png">
<link rel="apple-touch-icon" href="avatar.png">
<meta name="theme-color" content="#000000">

<style>
  body {
    margin: 0;
    overflow: hidden;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: "Georgia", serif;
    color: white;
  }
  h1 {
    position: absolute; top: 20px; width: 100%; text-align: center;
    font-size: 2em; color: #e0b36b;
    animation: pulse 3s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.85} }
  #avatarCanvas { width:100%; height:100%; display:block; }
  #micBtn {
    position:absolute; bottom:60px; left:50%;
    transform:translateX(-50%);
    width:80px; height:80px;
    border-radius:50%; border:none; background:#222;
    color:white; font-size:32px; cursor:pointer;
  }
  #micBtn:hover { background:#444; }
</style>
</head>

<body>
<h1>Frag Friedrich</h1>
<div id="loading">Avatar wird geladenâ€¦</div>
<canvas id="avatarCanvas"></canvas>
<button id="micBtn">ðŸŽ¤</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
/* -----------------------------
   STATE MACHINE
----------------------------- */
let model, STATE = "idle";   // idle â†’ greet â†’ listen â†’ hmmm â†’ answer â†’ idle
let lastTranscript = "";
let talking = false, greeted = false;

let hmNeigen = false, hmStartTime = 0;
let rising = false, riseStartTime = 0;
let hmStarted = false;

const hmDuration = 2000;
const riseDuration = 1200;

/* Basis â€“ leicht nach AVATAR-RECHTS geneigt */
let baseRotY = -0.35;
let baseRotX = 0.25;
let baseY = 0;

/* -----------------------------
   THREE.js SETUP
----------------------------- */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(30, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0,0,2.8);
const renderer = new THREE.WebGLRenderer({canvas: document.getElementById("avatarCanvas"), antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setClearColor(0x000000);

/* Licht â€“ Gold bleibt GOLD! */
scene.add(new THREE.DirectionalLight(0xffffff,2).position.set(1,1,2));
scene.add(new THREE.AmbientLight(0xffffff,0.8));
scene.add(new THREE.PointLight(0xffffff,0.8).position.set(0,0.5,2));

/* -----------------------------
   MODEL LADEN
----------------------------- */
const loader = new THREE.GLTFLoader();
loader.load("./avatar.glb", gltf=>{
  model = gltf.scene;

  const box = new THREE.Box3().setFromObject(model);
  const size = box.getSize(new THREE.Vector3());
  model.scale.setScalar( (1.5 / Math.max(size.x,size.y,size.z)) * 0.8 );
  const center = box.getCenter(new THREE.Vector3());
  model.position.sub(center);

  /* â†’ Idle Pose (leicht nach RECHTS) */
  model.rotation.y = baseRotY - Math.PI/2;
  model.rotation.x = baseRotX;

  scene.add(model);
  document.getElementById("loading").style.display = "none";
  animate();
});

/* -----------------------------
   ANIMATE LOOP
----------------------------- */
function animate(){
  requestAnimationFrame(animate);
  if(!model) return;

  const now = performance.now();

  // 1) BegrÃ¼ÃŸung ODER Antwort: langsam frontal
  if(rising){
    const t = (now - riseStartTime) / riseDuration;
    model.rotation.y = THREE.MathUtils.lerp(model.rotation.y, -Math.PI/2, 0.03);
    model.rotation.x = THREE.MathUtils.lerp(model.rotation.x, 0, 0.03);
    if(t >= 1) rising = false;
  }

  // 2) â€žHmmmâ€¦ einen Momentâ€œ â€“ nach AVATAR-LINKS neigen
  else if(hmNeigen){
    const t = Math.min(1, (now - hmStartTime) / hmDuration);
    model.rotation.x = THREE.MathUtils.lerp(model.rotation.x, baseRotX + 0.3, t);
    model.rotation.y = THREE.MathUtils.lerp(model.rotation.y, baseRotY - 0.3 - Math.PI/2, t);
  }

  // 3) WÃ„HREND der Antwort â†’ langsam zurÃ¼ck nach frontal
  else if(talking){
    model.position.y = baseY + Math.sin(now * 0.0015) * 0.008;
    model.rotation.y = THREE.MathUtils.lerp(model.rotation.y, -Math.PI/2, 0.02);
    model.rotation.x = THREE.MathUtils.lerp(model.rotation.x, 0, 0.02);
  }

  // 4) Idle â†’ leicht nach AVATAR-RECHTS geneigt
  else{
    model.rotation.y = THREE.MathUtils.lerp(model.rotation.y, baseRotY - Math.PI/2, 0.02);
    model.rotation.x = THREE.MathUtils.lerp(model.rotation.x, baseRotX, 0.02);
  }

  renderer.render(scene,camera);
}

/* -----------------------------
   SPEECH RECOGNITION
----------------------------- */
let recognition;
if("webkitSpeechRecognition" in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang = "de-DE";
  recognition.continuous = false;

  recognition.onresult = e => lastTranscript = e.results[0][0].transcript;

  recognition.onend = () => {
    if(STATE === "listen" && lastTranscript){
      STATE = "hmmm";
      hmNeigen = true;
      hmStartTime = performance.now();

      speak("Hmmmm... einen Moment", true);

      // ðŸ‘‰ Frage an dein Backend
      fetch("/ask", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({text: lastTranscript})
      })
      .then(r => r.json())
      .then(data => {
        STATE = "answer";
        rising = true;          // frontal drehen
        riseStartTime = performance.now();
        speaking = true;
        speak(data.answer);

        setTimeout(() => {
          model.rotation.y = baseRotY - Math.PI/2;   // â† Idle-Pose
          greeted = false;        // â†’ NÃ„CHSTER Mikrotipp = BegrÃ¼ÃŸung
        }, 500);
      });
    }
  };
}

/* -----------------------------
   BUTTON
----------------------------- */
document.getElementById("micBtn").onclick = () => {
  if(!greeted){
    greeted = true;
    STATE = "greet";
    rising = true;
    riseStartTime = performance.now();
    speak("Seid gegrÃ¼ÃŸt, mein Freund...", false);
    return;
  }
  recognition.start();
  STATE = "listen";
};

/* -----------------------------
   SPEAK FUNCTION
----------------------------- */
let maleVoice = null;
function speak(text, slow=false){
  if(!text) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "de-DE";
  u.rate = slow ? 0.5 : 0.95;
  u.onstart = () => talking=true;
  u.onend   = () => talking=false;
  speechSynthesis.speak(u);
}

</script>
</body>
</html>
